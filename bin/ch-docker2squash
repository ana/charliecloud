#!/bin/sh

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Flatten a Docker image into a Charliecloud image squashfs.

Usage:

  $ $(basename "$0") IMAGE OUTDIR [ARGS ...]

You must have sufficient privilege (via sudo) to run the Docker commands.
EOF
)

parse_basic_args "$@"

if [ "$#" -lt 2 ]; then
    usage
fi

image=$1
outdir=$2

shift 2

# Get image as a directory
"${ch_bin}/ch-docker2tar" "--nocompress" "$image" /tmp > /dev/null
"${ch_bin}/ch-tar2dir" "/tmp/${image}.tar" /tmp > /dev/null
# Create squashfs, and clean up intermediate files and folders.
"${ch_bin}/ch-dir2squash" "/tmp/${image}" "$outdir" "$@"
rm -rf "/tmp/${image}.tar"
rm -rf "/tmp/${image}"
